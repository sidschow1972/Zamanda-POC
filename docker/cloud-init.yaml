#cloud-config
package_update: true
package_upgrade: true

packages:
  - ca-certificates
  - curl
  - gnupg

write_files:
  - path: /home/azureuser/zammad/docker-compose.yml
    permissions: '0644'
    owner: azureuser:azureuser
    content: |
      services:
        zammad:
          image: zammad/zammad:latest
          restart: always
          ports:
            - "80:8080"
          environment:
            - ZAMMAD_RAILS_PORT=8080
            - POSTGRESQL_HOST=postgres
            - POSTGRESQL_PORT=5432
            - POSTGRESQL_USER=zammad
            - POSTGRESQL_PASS=zammadChangeMeNow
            - POSTGRESQL_DB=zammad_production
            - ELASTICSEARCH_HOST=elasticsearch
            - ELASTICSEARCH_PORT=9200
          volumes:
            - zammad-data:/opt/zammad
          depends_on:
            - postgres
            - elasticsearch

        postgres:
          image: postgres:15
          restart: always
          environment:
            - POSTGRES_USER=zammad
            - POSTGRES_PASSWORD=zammadChangeMeNow
            - POSTGRES_DB=zammad_production
          volumes:
            - postgres-data:/var/lib/postgresql/data

        elasticsearch:
          image: elasticsearch:8.11.3
          restart: always
          environment:
            - discovery.type=single-node
            - xpack.security.enabled=false
            - ES_JAVA_OPTS=-Xms512m -Xmx512m
          volumes:
            - es-data:/usr/share/elasticsearch/data

      volumes:
        zammad-data:
        postgres-data:
        es-data:

runcmd:
  # install docker (same as you already have, keep it)
  - install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  - chmod a+r /etc/apt/keyrings/docker.gpg
  - |
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
    https://download.docker.com/linux/ubuntu \
    $(. /etc/os-release && echo $VERSION_CODENAME) stable" \
    > /etc/apt/sources.list.d/docker.list
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
  - usermod -aG docker azureuser

  # bring up zammad automatically
  - mkdir -p /home/azureuser/zammad
  - chown -R azureuser:azureuser /home/azureuser/zammad
  - sudo -u azureuser sh -lc 'cd /home/azureuser/zammad && docker compose -f docker-compose.yml up -d'

